# ============================================
# 多用户协同配置 - 可莉 & 纳西妲
# 独立桌面操作 + 共享项目数据
# 统一入口：http://your-domain:6080/
# ============================================

services:
  # 网关 - 统一入口，用户选择界面
  gateway:
    image: nginx:alpine
    container_name: idea-gateway
    ports:
      - "${GATEWAY_PORT:-6080}:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./gateway/index.html:/usr/share/nginx/html/index.html:ro
    depends_on:
      - idea-user1
      - idea-user2
    restart: unless-stopped

  # 用户1 - 可莉的工作区
  idea-user1:
    build:
      context: .
      dockerfile: Dockerfile.vnc
      args:
        IDE_DOWNLOAD_URL: ${IDE_DOWNLOAD_URL:-https://download.jetbrains.com/idea/ideaIU-2024.3.1.1.tar.gz}
        VNC_PASSWORD: ${VNC_PASSWORD:-idea123}
        VNC_DISPLAY: 1
    container_name: idea-user1
    hostname: idea-user1
    ports:
      - "${VNC_PORT_USER1:-5901}:5901"
    expose:
      - "6080"
    volumes:
      - shared-projects:/home/developer/projects
      - idea-config-user1:/home/developer/.config
      - idea-cache-user1:/home/developer/.cache
      - idea-local-user1:/home/developer/.local
      - idea-vnc-user1:/home/developer/.vnc
      - idea-mozilla-user1:/home/developer/.mozilla
      - idea-desktop-user1:/home/developer/Desktop
      - idea-home-user1:/home/developer/.idea
      - idea-java-user1:/home/developer/.java
    environment:
      - TZ=Asia/Shanghai
    security_opt:
      - seccomp:unconfined
    restart: unless-stopped
    shm_size: '2gb'

  # 用户2 - 纳西妲的工作区
  idea-user2:
    build:
      context: .
      dockerfile: Dockerfile.vnc
      args:
        IDE_DOWNLOAD_URL: ${IDE_DOWNLOAD_URL:-https://download.jetbrains.com/idea/ideaIU-2024.3.1.1.tar.gz}
        VNC_PASSWORD: ${VNC_PASSWORD:-idea123}
        VNC_DISPLAY: 2
    container_name: idea-user2
    hostname: idea-user2
    ports:
      - "${VNC_PORT_USER2:-5902}:5902"
    expose:
      - "6080"
    volumes:
      - shared-projects:/home/developer/projects
      - idea-config-user2:/home/developer/.config
      - idea-cache-user2:/home/developer/.cache
      - idea-local-user2:/home/developer/.local
      - idea-vnc-user2:/home/developer/.vnc
      - idea-mozilla-user2:/home/developer/.mozilla
      - idea-desktop-user2:/home/developer/Desktop
      - idea-home-user2:/home/developer/.idea
      - idea-java-user2:/home/developer/.java
    environment:
      - TZ=Asia/Shanghai
    security_opt:
      - seccomp:unconfined
    restart: unless-stopped
    shm_size: '2gb'

volumes:
  shared-projects:
  idea-config-user1:
  idea-cache-user1:
  idea-local-user1:
  idea-vnc-user1:
  idea-mozilla-user1:
  idea-desktop-user1:
  idea-home-user1:
  idea-java-user1:
  idea-config-user2:
  idea-cache-user2:
  idea-local-user2:
  idea-vnc-user2:
  idea-mozilla-user2:
  idea-desktop-user2:
  idea-home-user2:
  idea-java-user2:
